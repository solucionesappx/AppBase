<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App JAL</title>
    <!-- Incluye el CDN de Tailwind CSS para un estilo rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la librería de iconos Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.1/css/all.css">
    <style>
        /* Importa la fuente Poppins de Google Fonts */
        @import url("https://fonts.com/css?family=Poppins:200,300,400,500,600,700,800,900&display=swap");

        /* Definición de variables CSS para el tema claro */
        :root {
            --bg-color: #f0f2f5;
            --box-color: #e9ecef;
            --border-color: #000; /* Color de borde negro puro para el modo claro  */
            --text-color: #111;
            --link-color: #D61336;
            --accent-color-1: #4041C2;
            --accent-color-2: #7aebbc;
            --box-shadow-color: rgba(0,0,0,0.2);
        }

        /* Variables para el tema oscuro */
        body.dark-mode {
            --bg-color: #25252b;
            --box-color: #3a3a45;
            --border-color: #25252b;
            --text-color: #fff;
            --link-color: #4041C2;
            --accent-color-1: #4041C2;
            --accent-color-2: #dbeb7a;
            --box-shadow-color: rgba(255,255,255,0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Evita el resaltado azul al hacer clic en dispositivos móviles */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            background-color: var(--box-color);
            color: var(--text-color);
            box-shadow: 0 4px 6px -1px var(--box-shadow-color), 0 2px 4px -1px var(--box-shadow-color);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Estilos del header */
        .header-bg {
            background-color: var(--box-color);
            color: var(--text-color);
        }
        .header-bg.dark-mode {
            background-color: var(--box-color);
        }
        .box-shadow {
            box-shadow: 0 4px 6px -1- var(--box-shadow-color), 0 2px 4px -1px var(--box-shadow-color);
        }

        /* Estilo para el toggle switch */
        .toggle-switch-container {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            border-radius: 30px;
            background-color: #dcdcdc; /* Color directo para evitar conflictos con el borde de la tabla */
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-button {
            position: absolute;
            left: 4px;
            top: 4px;
            width: 15px;
            height: 15px;
            background-color: var(--text-color);
            border-radius: 50%;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .toggle-switch-container.dark-mode {
            background-color: #2D59A1;
        }
        
        .toggle-switch-container.dark-mode .toggle-button {
            transform: translateX(20px);
            background-color: var(--box-color);
        }

        /* Estilos de la tabla */
        .data-table-container {
            /* La altura actual es de 450px; ajústala para mostrar aproximadamente 20 filas. Considera que la altura de cada fila puede variar según el tamaño de fuente y el padding. */
            max-height: 450px;
            overflow-y: auto;
            overflow-x: auto;
            width: 100%;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table {
            border-collapse: collapse;
            width: 100%;
            min-width: max-content;
        }
        
        /* Estilo para anclar el encabezado de la tabla */
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 30; /* Alto z-index para que la fila se mantenga sobre todo */
            background-color: #2D59A1;
            color: #fff; /* Se cambia el color de la fuente a blanco */
            box-shadow: 0 2px 4px var(--box-shadow-color);
        }

        .data-table th, .data-table td {
            padding: 0rem 0.6rem; /* El primer valor controla el espacio vertical, el segundo el horizontal. */
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            font-size: 0.875rem;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .data-table th {
            font-weight: 600;
            text-align: center;
        }

        .data-table tbody tr {
            /* Transición para el efecto de hover */
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .data-table tbody tr:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Estilos para el encabezado y las celdas de la primera columna (ID) */
        .data-table th:first-child, .data-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 20; /* Z-index menor que el encabezado para que quede debajo de él */
            background-color: #2D59A1;
            color: #fff; /* Se cambia el color de la fuente a blanco */
            font-weight: 600; /* Asegura el mismo peso de fuente */
            box-shadow: 2px 0 4px var(--box-shadow-color);
        }
        
        /* Asegura que la celda de la esquina se fije correctamente */
        .data-table th:first-child {
            z-index: 40;
        }

        .data-table th:last-child, .data-table td:last-child {
            border-right: none;
        }
        
        .text-right {
            text-align: right;
        }

        /* Regla de resaltado con hover (efecto de ratón) y cursor de puntero */
        .data-table tbody tr:hover {
            background-color: rgba(122, 235, 188, 0.6) !important;
            cursor: pointer;
        }

        /* Regla para el resaltado de la primera columna durante el hover */
        .data-table tbody tr:hover td:first-child {
            background-color: rgba(122, 235, 188, 0.6) !important;
        }

        /* Estilos del modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea el modal en la parte superior */
            padding-top: 10rem; /* Agrega un poco de espacio en la parte superior */
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .modal-content {
            background-color: var(--box-color);
            color: var(--text-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-container.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-field {
            /* Se reduce el margen inferior del campo para acercar los elementos */
            margin-bottom: 0.5rem;
        }
        
        .modal-field label {
            font-weight: 600;
            display: block;
            /* Se reduce el margen inferior para acercar el título al campo de datos */
            margin-bottom: 0.1rem;
            font-size: 0.875rem; /* text-sm */
            color: #3B82F6;
        }
        
        /* Estilos para los campos de datos en el modal */
        .modal-field span {
            font-weight: 400;
            background-color: var(--bg-color);
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: block;
            width: 100%;
        }

        .modal-field input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            border-radius: 0.25rem;
            color: var(--text-color);
        }

        .modal-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 1rem;
        }

        .modal-nav-button {
            background-color: transparent;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--accent-color-1);
            transition: color 0.2s ease;
        }

        .modal-nav-button:hover:not(:disabled) {
            color: var(--accent-color-2);
        }

        .modal-nav-button:disabled {
            color: #888;
            cursor: not-allowed;
        }

        /* Estilo para los botones de acción */
        .modal-action-button {
            padding: 0.5rem 1rem;
            background-color: #2D59A1;
            color: #fff;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }

    </style>
    <!-- Media query para ocultar la aplicación en pantallas de más de 450px -->
    <style>
        @media (min-width: 451px) {
            body {
                display: none;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- 1. Cintillo Fijo (Header) -->
    <header class="fixed top-0 left-0 w-full header-bg box-shadow z-50 transition-colors">
        <div class="container max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Mensaje de Bienvenida (Asume que el usuario está logueado) -->
            <div class="flex-row space-x-2">
                <span class="text-2xl font-semibold">¡Hola, Usuario!</span>
            </div>

            <div class="flex-row space-x-4 flex items-center">
                <!-- Botón de Modo Claro/Oscuro -->
                <div id="theme-toggle" class="toggle-switch-container dark-mode">
                    <div class="toggle-button"></div>
                </div>
                
                <!-- Botón para cerrar sesión -->
                <button class="nav-link text-xl" style="color: var(--text-color);">
                    <!-- Icono de cerrar sesión de Font Awesome -->
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenedor que crea un espacio entre el header y el contenido principal -->
    <div class="w-full h-20"></div>

    <!-- Contenedor principal optimizado para dispositivos móviles -->
    <div class="w-full max-w-lg mx-auto p-5 rounded-xl container relative">
        <!-- Loader visual -->
        <div id="loader" class="hidden absolute inset-0 flex justify-center items-center bg-gray-800 bg-opacity-50 z-50 rounded-xl">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
        </div>
        <h1 class="text-2xl font-bold mb-2 text-center">Datos del Personal</h1>
        <p class="text-sm mb-4 text-center">Tabla con datos cargados desde Google Apps Script.</p>
        
        <!-- Contenedor de búsqueda y ordenación, ahora siempre en una fila -->
        <div class="flex flex-row items-center space-x-2 mb-2">
            <input type="text" id="searchInput" placeholder="Buscar..." class="w-4/5 p-2 rounded-md border border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800" autocomplete="off">
            <button id="sortButton" class="text-3xl bg-transparent hover:text-blue-600 text-blue-500 font-bold py-2 px-4 rounded transition-colors duration-300 ease-in-out" aria-label="Ordenar por Apellidos">
                <i class="fa-solid fa-arrow-down-a-z"></i>
            </button>
            <button id="cancelButton" class="text-3xl text-red-600 hover:text-red-700 bg-transparent transition-colors focus:outline-none focus:ring-0">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <!-- Contenedor de la tabla -->
        <div class="data-table-container">
            <table id="Data-grid" class="data-table">
                <thead>
                    <tr>
                        <th class="text-right">ID</th>
                        <th>Empresa</th>
                        <th>Nómina</th>
                        <th>Apellidos</th>
                        <th>Nombres</th>
                        <th class="text-right">Cédula</th>
                        <th>Cargo</th>
                        <th class="text-right">Ingreso</th>
                        <th>Sector</th>
                        <th>Perfil</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos se renderizarán aquí con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contenedor del Modal -->
    <div id="detailsModal" class="modal-container hidden">
        <div class="modal-content relative">
            <!-- Botón de cerrar reubicado -->
            <button id="closeModalBtn" class="absolute top-2 right-2 text-2xl text-gray-400 hover:text-red-600 transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>

            <div class="modal-header">
                <div class="flex items-center space-x-4">
                    <h3 class="text-xl font-bold">Detalles</h3>
                    <div class="flex space-x-2">
                        <button id="prevPageBtn" class="modal-nav-button" disabled>
                            <i class="fa-solid fa-angle-left"></i>
                        </button>
                        <button id="nextPageBtn" class="modal-nav-button">
                            <i class="fa-solid fa-angle-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Contenido del modal (páginas de datos) -->
            <div id="modal-pages-container">
                <!-- Página 1: Campos Empresa, Nómina, Apellidos, Nombres, Cédula -->
                <div id="modal-page-1" class="modal-page">
                    <div class="modal-field">
                        <label>Empresa:</label>
                        <span id="field-empresa"></span>
                    </div>
                    <div class="modal-field">
                        <label>Nómina:</label>
                        <span id="field-nomina"></span>
                    </div>
                    <div class="modal-field">
                        <label>Apellidos:</label>
                        <span id="field-apellidos"></span>
                    </div>
                    <div class="modal-field">
                        <label>Nombres:</label>
                        <span id="field-nombres"></span>
                    </div>
                    <div class="modal-field">
                        <label>Cédula:</label>
                        <span id="field-cedula"></span>
                    </div>
                </div>

                <!-- Página 2: Campos Cargo, Ingreso, Sector, Perfil -->
                <div id="modal-page-2" class="modal-page hidden">
                    <div class="modal-field">
                        <label>Cargo:</label>
                        <span id="field-cargo"></span>
                    </div>
                    <div class="modal-field">
                        <label>Ingreso:</label>
                        <span id="field-ingreso"></span>
                    </div>
                    <div class="modal-field">
                        <label>Sector:</label>
                        <span id="field-sector"></span>
                    </div>
                    <div class="modal-field">
                        <label>Perfil:</label>
                        <span id="field-perfil"></span>
                    </div>
                </div>
            </div>

            <!-- Navegación del Modal -->
            <div class="modal-footer">
                <button id="acceptBtn" class="modal-action-button">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // Este código detecta si el dispositivo es móvil. Sin embargo, para esta solicitud,
        // la media query CSS es la mejor solución para ocultar la app en pantallas grandes.
        // Si quisieras cambiar el comportamiento dinámicamente, podrías usar esto:
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        // Cargar la preferencia de tema guardada en localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.classList.add('dark-mode');
        }

        // Alternar el tema al hacer clic en el toggle
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            themeToggle.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Código para la tabla: 
        document.addEventListener("DOMContentLoaded", () => {
            const DataGridBody = document.querySelector('#Data-grid tbody');
            const loader = document.getElementById('loader');
            const searchInput = document.getElementById('searchInput');
            const cancelButton = document.getElementById('cancelButton');
            const sortButton = document.getElementById('sortButton');
            
            // La URL de tu script de Google Apps
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbx87WvxA9ca1KyGMA1wsw1npZw5vPtjoItomhF823BICXScNrWGFh5m0Dj6Veb24CtHXQ/exec';

            // Mapeo de los encabezados del HTML a las claves de los datos JSON
            const headerMapping = {
                'Empresa': 'EMPRESA',
                'Nómina': 'NOMINA',
                'Apellidos': 'APELLIDOS',
                'Nombres': 'NOMBRES',
                'Cédula': 'CÉDULA',
                'Cargo': 'CARGO',
                'Ingreso': 'INGRESO',
                'Sector': 'SECTOR',
                'Perfil': 'PERFIL'
            };

            let allPersonData = []; // Variable para almacenar los datos completos.
            let originalPersonData = []; // Variable para almacenar una copia de los datos originales sin ordenar.

            /**
             * Función asíncrona para cargar los datos desde la fuente externa.
             */
            async function loadPersonData() {
                console.log("Cargando datos...");
                loader.classList.remove('hidden'); // Muestra el loader
                
                try {
                    const response = await fetch(`${GAS_URL}?sheet=V¿BD_Personal`);
                    const result = await response.json();

                    if (result.error) {
                        DataGridBody.innerHTML = `<tr><td colspan="10" class="text-center text-red-600">Error de la API: ${result.error}</td></tr>`;
                        console.error('GAS API Error:', result.error);
                        return;
                    }

                    allPersonData = result.data;
                    // Guarda una copia de los datos originales
                    originalPersonData = JSON.parse(JSON.stringify(result.data));
                    renderTable(allPersonData);
                    console.log("Datos cargados correctamente.");

                } catch (error) {
                    DataGridBody.innerHTML = `<tr><td colspan="10" class="text-center text-red-600">No se pudo conectar con el script. Por favor, asegúrese de que la URL sea correcta.</td></tr>`;
                    console.error('Fetch Error:', error);
                } finally {
                    loader.classList.add('hidden'); // Oculta el loader
                }
            }

            /**
             * Función para formatear la fecha a dd/mm/aaaa
             */
            function formatDate(date) {
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            }

            /**
             * Función para construir y mostrar la tabla a partir de los datos.
             * @param {Array<Object>} data - Un array de objetos con los datos a mostrar.
             */
            function renderTable(data) {
                // Elimina todas las filas de datos para renderizar la nueva versión
                DataGridBody.innerHTML = '';

                if (!data || data.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = '<td colspan="10" class="text-center">No hay datos para mostrar.</td>';
                    DataGridBody.appendChild(noDataRow);
                    return;
                }
                
                data.forEach((row, index) => {
                    const tableRow = document.createElement('tr');
                    // Asigna un índice a cada fila para poder identificarla en el modal
                    tableRow.dataset.index = index;

                    // Crea la celda del ID con el número correlativo
                    const idCell = document.createElement('td');
                    idCell.textContent = (index + 1);
                    idCell.classList.add('text-right');
                    tableRow.appendChild(idCell);

                    Object.keys(headerMapping).forEach((key, colIndex) => {
                        const cell = document.createElement('td');
                        const jsonKey = headerMapping[key];
                        let cellContent = row[jsonKey] || '';

                        if (key === 'Ingreso') {
                            cellContent = formatDate(cellContent);
                        }
                        
                        cell.textContent = cellContent;

                        if (key === 'Cédula' || key === 'Ingreso') {
                            cell.classList.add('text-right');
                        }
            
                        tableRow.appendChild(cell);
                    });
                    DataGridBody.appendChild(tableRow);
                });
            }

            /**
             * Filtra la tabla basada en el valor del input de búsqueda.
             */
            function filterTable() {
                const query = searchInput.value.toLowerCase();
                const filteredData = allPersonData.filter(row => {
                    return Object.values(row).some(value => {
                        // Convierta todos los valores a string para la búsqueda, incluso las fechas
                        return String(value).toLowerCase().includes(query);
                    });
                });
                renderTable(filteredData);
            }

            /**
             * Ordena la tabla por la columna de apellidos.
             */
            function sortData() {
                allPersonData.sort((a, b) => {
                    const apellidoA = a.APELLIDOS.toLowerCase();
                    const apellidoB = b.APELLIDOS.toLowerCase();
                    if (apellidoA < apellidoB) {
                        return -1;
                    }
                    if (apellidoA > apellidoB) {
                        return 1;
                    }
                    return 0;
                });
                renderTable(allPersonData);
            }
            
            // Event Listeners para la búsqueda dinámica y ordenación
            searchInput.addEventListener('input', filterTable);
            cancelButton.addEventListener('click', () => {
                searchInput.value = '';
                // Restablece la tabla a su estado original sin ordenar
                renderTable(originalPersonData);
            });
            sortButton.addEventListener('click', sortData);

            // Código para el modal
            const detailsModal = document.getElementById('detailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const acceptBtn = document.getElementById('acceptBtn');
            let currentPage = 1;
            const maxPages = 2;
            let selectedPerson = null;

            // Mapeo de las claves JSON a los elementos del DOM del modal
            const modalFieldsMap = {
                'APELLIDOS': document.getElementById('field-apellidos'),
                'CARGO': document.getElementById('field-cargo'),
                'CÉDULA': document.getElementById('field-cedula'),
                'EMPRESA': document.getElementById('field-empresa'),
                'INGRESO': document.getElementById('field-ingreso'),
                'NOMINA': document.getElementById('field-nomina'),
                'NOMBRES': document.getElementById('field-nombres'),
                'PERFIL': document.getElementById('field-perfil'),
                'SECTOR': document.getElementById('field-sector')
            };

            // Mapeo de la página a los campos que debe mostrar
            const pageMapping = {
                1: ['EMPRESA', 'NOMINA', 'APELLIDOS', 'NOMBRES', 'CÉDULA'],
                2: ['CARGO', 'INGRESO', 'SECTOR', 'PERFIL']
            };

            function showModal(personData) {
                selectedPerson = personData;
                currentPage = 1;
                updateModalContent();
                detailsModal.classList.remove('hidden');
                detailsModal.classList.add('active');
            }

            function hideModal() {
                detailsModal.classList.add('hidden');
                detailsModal.classList.remove('active');
            }

            function updateModalContent() {
                // Oculta todas las páginas
                document.querySelectorAll('.modal-page').forEach(page => page.classList.add('hidden'));

                // Muestra la página actual
                document.getElementById(`modal-page-${currentPage}`).classList.remove('hidden');

                // Actualiza los datos en los campos de la página actual
                const fieldsToShow = pageMapping[currentPage];
                fieldsToShow.forEach(key => {
                    let value = selectedPerson[key] || '';
                    if (key === 'INGRESO') {
                        value = formatDate(value);
                    }
                    modalFieldsMap[key].textContent = value;
                });

                // Control de los botones de navegación
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === maxPages;
            }

            // Evento para abrir el modal al hacer clic en una fila de la tabla
            DataGridBody.addEventListener('click', (event) => {
                const clickedRow = event.target.closest('tr');
                if (clickedRow) {
                    const index = clickedRow.dataset.index;
                    const personData = allPersonData[index];
                    if (personData) {
                        showModal(personData);
                    }
                }
            });

            // Evento para cerrar el modal
            closeModalBtn.addEventListener('click', hideModal);

            // Evento para navegar a la página siguiente
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < maxPages) {
                    currentPage++;
                    updateModalContent();
                }
            });

            // Evento para navegar a la página anterior
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateModalContent();
                }
            });

            // Evento para el botón de Aceptar
            acceptBtn.addEventListener('click', () => {
                // Aquí podrías agregar la lógica para guardar cambios, etc.
                console.log("¡Aceptar presionado! Lógica de guardado iría aquí.");
                hideModal();
            });


            // Llama a la función para iniciar la carga de datos al cargar la página
            loadPersonData();
        });
    </script>
</body>
</html>
