<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ZXC - Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family:'Inter',sans-serif; -webkit-tap-highlight-color:transparent; }
        :root { --bg: #1f2937;--txt: #f3f4f6;--surf: #374151;--p-soft: #60a5fa; } /* VARIABLES POR DEFECTO (DARK) */
        .light-mode { --bg: #f9fafb; --txt: #111827; --surf: #ffffff; } 
        .light-mode header, .light-mode footer { border-color: #e5e7eb; }
        html, body { background-color: var(--bg); color: var(--txt); transition: background .3s, color .3s; }   
        #app-container { width:100%; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; box-shadow:0 0 20px rgba(0,0,0,.2); position:relative; transition:max-width .4s ease-in-out; }
        #app-container { background-color: var(--bg); }
        .mode-mobile { max-width:500px; }
        .mode-desktop { max-width:100%!important; }
        header,footer { width:100%; max-width:inherit; z-index:50; left:50%; transform:translateX(-50%); position:fixed; background:var(--surf); border-color:#4b5563; }
        header { background: #374151 !important;color: #f3f4f6 !important;border-color: #4b5563 !important;}
        header h1 { color: white !important; }       
        main { flex-grow:1; overflow-y:auto; padding:76px 1rem 72px; }
        .footer-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:.75rem; color:var(--txt); cursor:pointer; transition:color .2s; }
        .footer-btn:hover { color:#152c94; }
        .footer-btn.active { color:var(--p-soft); font-weight:700; }
        .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.8); backdrop-filter:blur(4px); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--surf); border:1px solid #4b5563; border-radius:1rem; width:90%; max-width:320px; }
        .light-mode .modal-content { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display:none; }
        .btn-disabled { opacity: 0.3 !important;cursor: not-allowed !important;pointer-events: none !important;filter: grayscale(1); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
    <style>
        /* ESTILOS ESPECFICOS DE LA SECCIN (SPA FormData) */
        .input-form{margin-top:0.25rem;display:block;width:100%;padding:0.5rem 1rem;background-color:#1f2937;border:1px solid #4b5563;border-radius:0.5rem;color:white;outline:none}
        .input-form:focus{border-color:#3b82f6}
    </style>
</head>
<body class="dark">
    <div id="app-container" class="mode-mobile shadow-xl">
        <header class="top-0 h-14 border-b flex items-center justify-between px-6">
            <h1 class="text-xl font-bold text-white truncate mr-2">Cargando...</h1>
            <div class="flex items-center gap-3">
                <button id="btn-toggle-view" class="p-2" onclick="toggleView()"><div id="view-icon-container"></div></button>
                <button class="p-2 text-red-400" onclick="logout()"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </div>
        </header>

        <main id="main-content" class="relative"> <div id="global-loader" class="hidden absolute inset-0 z-[100] flex items-center justify-center rounded-xl bg-gray-900/60 backdrop-blur-sm">
                <div class="flex flex-col items-center p-8 bg-gray-800/95 border border-blue-500/40 rounded-2xl shadow-2xl min-w-[320px] transform -translate-y-10">
                    <div class="relative mb-4">
                        <i data-lucide="loader-2" class="w-10 h-10 text-blue-400 animate-spin"></i>
                    </div>
                    <span class="text-blue-400 font-bold text-sm tracking-wider uppercase text-center">Cargando Base de Datos</span>
                    <p class="text-gray-400 text-[10px] mt-2 text-center leading-relaxed">
                        Sincronizando registros con Google Sheets<br>Por favor, espere.
                    </p>
                </div>
            </div>
            <div id="DetalleDataContent" class="p-6 bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                    <h3 id="viewTitle" class="text-2xl font-bold text-blue-400">Detalle Selecci贸n</h3>
                    <div class="flex gap-4">
                        <button onclick="showRegisterMode()" class="text-green-400 hover:scale-110 transition-transform" title="Nuevo Registro">
                            <i data-lucide="file-plus-2" class="w-6 h-6"></i>
                        </button>
                        <button onclick="showEditMode()" class="text-yellow-400 hover:scale-110 transition-transform" title="Editar Registro">
                            <i data-lucide="file-pen" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <div id="perfilBodyContent" class="space-y-1 pb-20"></div>
            </div>
            <div id="EditDataContent" class="hidden p-6 bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                    <h2 id="formTitle" class="text-2xl font-bold text-white">Editar Selecci贸n</h2>
                    <div class="flex items-center gap-4">                   
                        <button onclick="showViewMode()" class="text-red-400 hover:scale-110 transition-transform">
                            <i data-lucide="circle-x" class="w-7 h-7"></i>
                        </button>
                    </div>
                </div>               
                <form id="editDataForm" class="space-y-1">
                    <input type="hidden" id="formAction" name="action" value="editDynamicDataTD">                   
                    <div id="editDataFormFields" class="space-y-1"></div>                   
                    <button id="submitBtn" type="submit" class="w-full bg-blue-600 mt-6 py-4 rounded-lg font-bold text-white hover:bg-blue-700 transition-all active:scale-95 shadow-lg flex items-center justify-center gap-2">
                        <span>Guardar Cambios</span>
                        <i data-lucide="save" class="w-5 h-5"></i>
                    </button>
                </form>               
                <p class="text-sm text-gray-400 text-center pt-4 pb-12">
                    Los campos que no sean modificados mantendr谩n su valor original.
                </p>
            </div>
        </main>

        <footer id="app-footer" class="bottom-0 h-18 border-t flex items-center justify-around px-2 py-1">
            <button class="footer-btn" data-section="Base"><i data-lucide="house-plus" class="w-6 h-6"></i><span>Base</span></button>
            <button id="btn-datos" class="footer-btn active" data-section="Datos"><i data-lucide="database" class="w-6 h-6"></i><span>Datos</span></button>
            <button id="btn-agregar" class="footer-btn" data-section="Agregar"><i data-lucide="plus-circle" class="w-6 h-6"></i><span>Agregar</span></button>
            <button class="footer-btn" data-section="Perfil"><i data-lucide="user" class="w-6 h-6"></i><span>Perfil</span></button>
            <button class="footer-btn" data-section="Configuracion"><i data-lucide="settings" class="w-6 h-6"></i><span>Config</span></button>
        </footer>
    </div>

    <div id="system-modal" class="hidden modal-overlay">
        <div class="modal-content p-6 text-center">
            <div id="sys-modal-icon" class="mb-4 flex justify-center"></div>
            <h3 id="sys-modal-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="sys-modal-text" class="text-gray-400 text-sm mb-6"></p>
            <div id="sys-modal-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <script>
        const KEYS={NOMBRE:'Usuario_Nombre',PERFIL:'Usuario_Perfil',CORREO:'Usuario_Correo',VIEW_MODE:'App_View_Mode',THEME:'App_Theme',TIENDA:'Usuario_Tienda',TIENDA_ID:'Usuario_Tienda_ID',USUARIO_ID:'Usuario_ID'};
        document.addEventListener('DOMContentLoaded',()=>{if(!localStorage.getItem(KEYS.CORREO))window.location.replace('index.html');initUI();if(window.lucide)lucide.createIcons()});
        function initUI(){
            const nom = localStorage.getItem(KEYS.NOMBRE);
            if(nom) document.querySelector('h1').textContent = `隆Hola, ${nom.trim().split(/\s+/)[0]}!`;
            applyViewMode(localStorage.getItem(KEYS.VIEW_MODE) || 'mobile');
            document.querySelectorAll('.footer-btn').forEach(b => b.onclick = () => loadContent(b.getAttribute('data-section')));
            if(!localStorage.getItem(KEYS.INPUT_ID)){['btn-agregar'].forEach(id => {const el = document.getElementById(id);if(el) el.classList.add('btn-disabled'); });}
        }
        function toggleView(){const m=localStorage.getItem(KEYS.VIEW_MODE)==='desktop'?'mobile':'desktop';localStorage.setItem(KEYS.VIEW_MODE,m);applyViewMode(m)}
        function applyViewMode(m){
            const c=document.getElementById('app-container'),i=document.getElementById('view-icon-container');
            if(m==='desktop'){c.classList.replace('mode-mobile','mode-desktop');i.innerHTML='<i data-lucide="smartphone" class="w-5 h-5 text-blue-400"></i>'}
            else{c.classList.replace('mode-desktop','mode-mobile');i.innerHTML='<i data-lucide="monitor" class="w-5 h-5 text-emerald-400"></i>'}
            if(window.lucide)lucide.createIcons();
        }
        async function loadContent(s){
            const NAV={'Base':'Base2.html','Inicio':'Inicio.html','Datos': 'Datos2.html','Agregar':'AgregarDat.html','Perfil':'PerfilUser2.html','Configuracion':'ConfigApp.html'};
            if(['Agregar'].includes(s) && !localStorage.getItem(KEYS.INPUT_ID)){return showSystemModal({title:'Acceso Imposible', text:'Registre el dato CLAVE para su b煤squeda en la secci贸n correspondiente.', type:'warning'});}    
            if(s==='Configuracion' && localStorage.getItem(KEYS.PERFIL)!=='Admin') return showSystemModal({title:'Acceso Denegado',text:'Solo administradores.',type:'warning'});
            if(NAV[s]) window.location.href=NAV[s];
        }     
        function showSystemModal({title,text,type='info'}){
            return new Promise(res=>{
                const m=document.getElementById('system-modal'),ti=document.getElementById('sys-modal-title'),te=document.getElementById('sys-modal-text'),ic=document.getElementById('sys-modal-icon'),ac=document.getElementById('sys-modal-actions');
                ti.textContent=title;te.textContent=text;const colors={warning:'text-amber-400',info:'text-blue-400'},icons={warning:'alert-triangle',info:'info'};
                ic.innerHTML=`<i data-lucide="${icons[type]}" class="w-12 h-12 ${colors[type]}"></i>`;ac.innerHTML='';
                const b=document.createElement('button');b.className='px-6 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold';b.textContent='Aceptar';
                b.onclick=()=>{m.classList.add('hidden');res(true)};ac.appendChild(b);m.classList.remove('hidden');lucide.createIcons();
            });
        }
        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light-mode');
            localStorage.setItem(KEYS.THEME, isLight ? 'light' : 'dark');
            renderTiendaFooter();
            if(window.lucide) lucide.createIcons();
        }
        function applyTheme() {
            const theme = localStorage.getItem(KEYS.THEME) || 'dark';
            if (theme === 'light') {document.documentElement.classList.add('light-mode');} 
            else {document.documentElement.classList.remove('light-mode');}
        }
        function toggleGlobalLoader(show) {
            const loader = document.getElementById('global-loader');
            if (loader) { loader.classList.toggle('hidden', !show);
            if (show && window.lucide) lucide.createIcons(); }
        }
        function formatNumberWithDots(v) {
            if (!v && v !== 0) return '';
            const number = parseFloat(String(v).replace(',', '.'));
            if (isNaN(number)) return v;
            const decimals = Math.abs(number - Math.round(number)) < 0.001 ? 0 : 2;
            return new Intl.NumberFormat('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(number);
        }
        function formatDate(v) {
            if (!v) return 'N/A';
            const d = new Date(v);
            return isNaN(d.getTime()) ? v : `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
        }
        function formatDateTime(v) {
            if (!v) return 'N/A';
            const d = new Date(v);
            if (isNaN(d.getTime())) return v;
            return `${formatDate(v)} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
        }
        function getFormattedValue(key, value) {
            if (value === null || value === undefined || value === '') return '';
            const cleanKey = String(key).toUpperCase();           
            if (cleanKey.includes('REGISTRODATA')) { return formatDateTime(value);}
            if (cleanKey.includes('FECHA')) { return formatDate(value);}
            const isPotentiallyNumber = typeof value === 'number' || 
                (!isNaN(parseFloat(value)) && isFinite(value) && String(value).length < 15);
            if (isPotentiallyNumber && !cleanKey.includes('ID') && !cleanKey.includes('DATA')) {
                return formatNumberWithDots(value);}
            return value;
        }
        function logout(){localStorage.clear();window.location.href='index.html'}

    </script>

    <script>
        function setupNombreCAutoCalculate(tablePrefix) {
            const n1 = document.getElementById(`input-${tablePrefix}NOMBRE1`);
            const n2 = document.getElementById(`input-${tablePrefix}NOMBRE2`);
            const nc = document.getElementById(`input-${tablePrefix}NOMBREC`);
            if (!n1 || !n2 || !nc) return;
            const particles = ["de los", "de la", "de", "del", "mc"];
            const processNombre1 = (text) => {
                const val = text.trim();
                if (!val) return "";
                const parts = val.split(/\s+/);               
                for (let i = 0; i < parts.length; i++) {
                    for (let p of particles) {
                        const pParts = p.split(" ");
                        if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                            const blockBefore = parts.slice(0, i + pParts.length).join(" ");
                            if (parts[i + pParts.length]) {
                                const initial = parts[i + pParts.length].charAt(0).toUpperCase();
                                return `${blockBefore} ${initial}.`; // Ej: MARIA DE LOS C.
                            }
                            return blockBefore;
                        }
                    }
                }
                let res = parts[0];
                if (parts[1]) res += " " + parts[1].charAt(0).toUpperCase() + ".";
                return res;
            };
            const processNombre2 = (text) => {
                const val = text.trim();
                if (!val) return "";
                if (val.toLowerCase().startsWith("o'")) {
                    const parts = val.split(/\s+/);
                    return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
                }
                const parts = val.split(/\s+/);
                for (let p of particles) {
                    const pParts = p.split(" ");
                    if (parts.slice(0, pParts.length).join(" ").toLowerCase() === p) {
                        const mainBlock = parts.slice(0, pParts.length + 1).join(" ");
                        const remaining = parts.slice(pParts.length + 1);
                        return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                    }
                    for (let i = 1; i < parts.length; i++) {
                        if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                            const mainBlock = parts.slice(0, i + pParts.length + 1).join(" ");
                            const remaining = parts.slice(i + pParts.length + 1);
                            return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                        }
                    }
                }
                return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
            };
            const calculate = () => {
                const n1Val = processNombre1(n1.value);
                const n2Val = processNombre2(n2.value);               
                let final = n1Val;
                if (n2Val) final += (final ? " " : "") + n2Val;
                nc.value = final.toUpperCase();
            };
            n1.addEventListener('input', calculate);
            n2.addEventListener('input', calculate);
        }

console.group(" REVISIN DE LOCALSTORAGE");
console.log(" Datos de Usuario (KEYS):");
Object.entries(KEYS).forEach(([key, storageKey]) => {
    console.log(`   ${key}: ${localStorage.getItem(storageKey)}`);
});

console.log(" Configuraci贸n de Tabla (TABLE_CONFIG):");
console.table(JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}'));

console.log(" Datos de la Fila (TABLE_DATA):");
console.table(JSON.parse(localStorage.getItem('TABLE_DATA') || '{}'));
console.groupEnd();

    </script>

    <script>
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVcnPmbbR9RXy6ekkvHT6ocTgm0Rsf1wxNQvQpSbEt7ubGVwBhxKqhNm0YeO_dI_XJIg/exec";
        const STORAGE_CONFIG = 'TABLE_CONFIG';
        const STORAGE_DATA = 'TABLE_DATA';

        document.addEventListener('DOMContentLoaded', async () => { 
            if (!localStorage.getItem(KEYS.CORREO)) {
                window.location.replace('index.html');
                return;
            }

            const rawData = localStorage.getItem(STORAGE_DATA);
            const rawConfig = localStorage.getItem(STORAGE_CONFIG);

            if (rawData && rawConfig) {
                const data = JSON.parse(rawData);
                const config = JSON.parse(rawConfig);
                const isNew = data.IS_NEW === true;
                const tableName = data.TABLA_ORIGEN;
                
                if (!tableName) {
                    console.error("Error: No se defini贸 la tabla de origen.");
                    window.location.href = 'Datos2.html';
                    return;
                }

                if (window.toggleGlobalLoader) toggleGlobalLoader(true);
                await fetchMasterData(tableName);
                if (window.toggleGlobalLoader) toggleGlobalLoader(false);
                renderProfile();               
                const friendlyName = getFriendlyTableName(tableName);
                const viewTitleEl = document.getElementById('viewTitle');
                if (viewTitleEl) {
                    viewTitleEl.textContent = `Detalle Selecci贸n: ${friendlyName}`;
                }
                
                const form = document.getElementById('editDataForm');
                if (isNew) {
                    const friendlyName = getFriendlyTableName(tableName);
                    document.getElementById('formTitle').textContent = `Nuevo Registro: ${friendlyName}`;
                    
                    document.getElementById('formAction').value = "registerDynamicDataTD";
                    document.getElementById('submitBtn').textContent = "Crear Nuevo Registro";
                    const btnEdit = document.querySelector('button[onclick="showEditMode()"]');

                    if (btnEdit) btnEdit.classList.add('hidden');
                    
                    renderFields(config, { TABLA_ORIGEN: tableName }, true);
                    togglePanels('edit');
                    if (form) form.onsubmit = handleInsertSubmit;
                } else {
                    renderFields(config, data, false);
                    if (form) form.onsubmit = handleEditSubmit;
                }

            } else {
                window.location.href = 'Datos2.html';
            }
        });

        async function loadTableNames() {
            const tienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
            try {
                const r = await fetch(`${GAS_SCRIPT_URL}?action=getTableFriendlyNames&appTienda=${tienda}`);
                const res = await r.json();
                if (res.success) {
                    // Guardamos el mapa de nombres amigables
                    localStorage.setItem('TABLE_FRIENDLY_NAMES', JSON.stringify(res.data));
                }
            } catch (e) { console.error("Error cargando nombres amigables", e); }
        }

        function getFriendlyTableName(technicalName) {
            const raw = localStorage.getItem('TABLE_FRIENDLY_NAMES');
            const friendlyNames = JSON.parse(raw || '{}');
            return friendlyNames[technicalName]?.label || technicalName;
        }

        function updateFormTitle(technicalName, isNew = false) {
            const label = getFriendlyTableName(technicalName);
            const formTitleEl = document.getElementById('formTitle');
            if (formTitleEl) {
                const accion = isNew ? "Nuevo Registro" : "Editar Selecci贸n";
                formTitleEl.textContent = `${accion}: ${label}`;
            }
        }

        async function fetchMasterData(currentTable) {
            const userTienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
            const now = Date.now();
            const cacheDuration = 5 * 60 * 1000;
            const tablesToFetch = [{ name: "TV001_VALORES", key: "FULL_DATA_TV001", time: "TV001_TIMESTAMP" }];

            if (currentTable && currentTable !== "TV001_VALORES") {
                tablesToFetch.push({ 
                    name: currentTable, 
                    key: `FULL_DATA_${currentTable.split('_')[0]}`, 
                    time: `${currentTable.split('_')[0]}_TIMESTAMP` 
                });
            }

            for (const t of tablesToFetch) {
                const lastFetch = localStorage.getItem(t.time);
                if (!localStorage.getItem(t.key) || (now - lastFetch > cacheDuration)) {
                    try {
                        const r = await fetch(`${GAS_SCRIPT_URL}?action=getTableData&tableName=${t.name}&userTienda=${userTienda}&ignoreVisibility=true`);
                        const res = await r.json();
                        if (res.success) {
                            localStorage.setItem(t.key, JSON.stringify(res.data));
                            localStorage.setItem(t.time, now.toString());
                        }
                    } catch (e) { console.error("Error cargando maestro:", t.name, e); }
                }
            }
        }

        function getTablePrimaryKey(headers, tableName) {
            const prefix = tableName.split('_')[0].toUpperCase();
            return headers.find(h => h.trim().toUpperCase() === `${prefix}ID`) || headers[0];
        }

        function renderProfile() {
            const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG) || '{}');
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
            const container = document.getElementById('perfilBodyContent');
            const prefix = (data.TABLA_ORIGEN || "").split('_')[0].toUpperCase();
            
            const isBlocked = data[`${prefix}TYPEREG`] === "Bloqueado";

            container.innerHTML = Object.keys(config).map(colId => {
                const cleanId = colId.toUpperCase().trim();
                if (cleanId === `${prefix}ID` || cleanId === `${prefix}TYPEREG`) return ''; // Ocultar ID y TYPEREG en vista perfil

                const label = config[colId].label;
                const value = data[colId] || '---';
                const isIdentity = cleanId === `${prefix}IDNOMBRE`;
                
                const valueClass = cleanId.includes('NOMBREC') || cleanId.includes('DAT01') || cleanId.includes('IDNOMBRE')
                    ? 'text-[22px] text-blue-300 font-bold' 
                    : 'text-[18px] text-gray-200';

                const badge = (isIdentity && isBlocked) ? 
                    `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30 uppercase font-bold">Bloqueado</span>` : '';
// etiquetas de campos input modo VIEW
                return `
                    <div class="border-b border-gray-700/40 py-1"> 
                        <span class="text-[10px] font-bold text-gray-500 uppercase block -mb-1">${label}</span>
                        <div class="flex items-center min-h-[32px]">
                            <span class="${valueClass}">${value}</span>
                            ${badge}
                        </div>
                    </div>`;
            }).join('');
            if(window.lucide) lucide.createIcons();
        }

        function renderFields(config, data, isNew = false) {
            const container = document.getElementById('editDataFormFields');
            if (!container) return;

            // 1. Contexto de tabla y prefijo
            const tableName = data.TABLA_ORIGEN || "TD101_BASIC";
            const prefix = tableName.split('_')[0].toUpperCase();
            
            // 2. Manejo de Estatus (Evita el "undefined" visual)
            const statusKey = `${prefix}TYPEREG`;
            const currentStatus = data[statusKey] || ""; // Si no existe, string vac铆o
            const isBlocked = currentStatus === "Bloqueado";

            // 3. Recursos externos
            const tv001 = JSON.parse(localStorage.getItem('FULL_DATA_TV001') || '[]');
            const selectHydrations = [];

            // 4. Generaci贸n de HTML
            container.innerHTML = Object.keys(config).map(colId => {
                const field = config[colId];
                const cleanId = colId.toUpperCase().trim();
                let value = isNew ? '' : (data[colId] || '');

                // --- CASO A: CAMPO DE IDENTIDAD CON TOGGLE (IDNOMBRE) ---
                if (cleanId === `${prefix}IDNOMBRE`) {
                    return renderToggleHTML(field.label, value, currentStatus, isBlocked, prefix, colId);
                }

                // --- CASO B: PRIMARY KEY (OCULTO) ---
                if (cleanId === `${prefix}ID`) {
                    return isNew ? '' : `<input type="hidden" name="${colId}" value="${value}">`;
                }

                // --- LGICA DE EDICIN Y ESTILOS ---
                const isCalculated = cleanId.includes('NOMBREC');
                const isSystem = cleanId.includes('REGISTRO') || cleanId === `${prefix}DAT01`;
                
                // El campo DAT01 suele ser de sistema pero podr铆as quererlo editable en New
                const canEdit = isNew 
                    ? (!isCalculated && !cleanId.includes('REGISTRO') && field.editable !== false) 
                    : field.editable !== false;

                // --- CASO C: SELECTORES (CATLOGOS TV001) ---
                const masterMatch = tv001.filter(row => 
                    row.Encabezado_Tabla && row.Encabezado_Tabla.toUpperCase().trim() === cleanId
                );

                if (masterMatch.length > 0 && canEdit) {
                    selectHydrations.push({ 
                        id: `select-${cleanId}`, 
                        options: masterMatch.map(m => m.Valores_Encabezado), 
                        current: value 
                    });
                    return `
                        <div class="border-b border-gray-700/40 py-1">
                            <span class="text-[10px] font-bold text-blue-400 uppercase block -mb-1">${field.label}</span>
                            <select name="${colId}" id="select-${cleanId}" 
                                class="w-full bg-gray-800 text-blue-300 outline-none border-none text-[18px] font-bold p-0 appearance-none cursor-pointer">
                                <option value="${value}">${value || 'Seleccione...'}</option>
                            </select>
                        </div>`;
                }

                // --- CASO D: INPUT NORMAL (TEXTO/NMEROS) ---
                const isImportant = cleanId.includes('NOMBREC') || cleanId.includes('DAT01');
                const textClass = isImportant ? 'text-blue-300 font-bold text-[22px]' : 'text-gray-200 text-[18px]';

                return `
                    <div class="border-b border-gray-700/40 py-1">
                        <span class="text-[10px] font-bold text-blue-400 uppercase block -mb-1">${field.label}</span>
                        <input type="text" name="${colId}" value="${value}" 
                            ${!canEdit ? 'readonly' : ''}
                            class="w-full bg-transparent outline-none border-none ${textClass} p-0 m-0 ${!canEdit ? 'opacity-60' : ''}">
                    </div>`;
            }).join('');

            // 5. Inicializaci贸n post-render
            if (window.lucide) lucide.createIcons();
            hydrateAllSelects(selectHydrations);
        }

        function hydrateAllSelects(hydrations) {
            hydrations.forEach(item => {
                const el = document.getElementById(item.id);
                if (!el) return;
                const flat = item.options.flatMap(opt => {
                    try { return (typeof opt === 'string' && opt.startsWith('[')) ? JSON.parse(opt) : opt; } catch { return opt; }
                });
                const unique = [...new Set(flat)].filter(Boolean).sort();
                el.innerHTML = `<option value="">-- Seleccionar --</option>` + 
                    unique.map(val => `<option value="${val}" ${String(val).trim() === String(item.current).trim() ? 'selected' : ''}>${val}</option>`).join('');
            });
        }

        // --- MANEJO DE FORMULARIOS ---

        async function handleEditSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = "Procesando...";
            submitBtn.disabled = true;

            const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
            const tableName = currentData.TABLA_ORIGEN || "TD101_BASIC";
            const tablePrefix = tableName.split('_')[0].toUpperCase();
            const headers = Object.keys(currentData).filter(k => k !== 'TABLA_ORIGEN');
            const primaryKeyField = getTablePrimaryKey(headers, tableName);
            
            const formData = new FormData(e.target);
            const formEntries = Object.fromEntries(formData.entries());

            const payload = {
                action: "editDynamicDataTD",
                TABLA_DESTINO: tableName,
                CAMPO_CLAVE: primaryKeyField,
                ...currentData,
                ...formEntries,
                [`${tablePrefix}TYPEREG`]: document.getElementById('input-typereg')?.value || currentData[`${tablePrefix}TYPEREG`],
                currentUser: localStorage.getItem(KEYS.USUARIO_ID) || "UserSys"
            };

            delete payload.TABLA_ORIGEN;
            delete payload.IS_NEW;

            // Llamamos a la funci贸n centralizada
            await executeSubmit(payload, 'Actualizaci贸n');
            
            // El bot贸n se restaura si algo falla (si tiene 茅xito, la p谩gina se recarga)
            submitBtn.textContent = "Guardar Cambios";
            submitBtn.disabled = false;
        }

    </script>

    <script>

        function toggleRecordStatus(prefix) {
            const input = document.getElementById('input-typereg');
            const badge = document.getElementById('badge-status');
            const icon = document.getElementById('toggle-icon');
            const isNowBlocking = input.value !== "Bloqueado";
            if (isNowBlocking) {
                input.value = "Bloqueado";
                badge.textContent = "Bloqueado";
                badge.className = "text-[10px] px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30 uppercase font-bold transition-all";
                icon.style.color = "#ef4444";
                icon.setAttribute('data-lucide', 'toggle-left');
            } else {
                input.value = ""; // O "Registrado", seg煤n prefieras en tu BD
                badge.textContent = "Registrado";
                badge.className = "text-[10px] px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 border border-green-500/30 uppercase font-bold transition-all";
                icon.style.color = "#22c55e";
                icon.setAttribute('data-lucide', 'toggle-right');
            }           
            if(window.lucide) lucide.createIcons();
        }

        async function handleInsertSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = "Procesando...";
            submitBtn.disabled = true;

            try {
                    const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
                    const tableName = currentData.TABLA_ORIGEN; 
                    const tablePrefix = tableName.split('_')[0].toUpperCase();
                    
                    const formData = new FormData(e.target);
                    const formPayload = Object.fromEntries(formData.entries());
                    const tiendaId = localStorage.getItem(KEYS.TIENDA_ID);
                    
                    if (!tiendaId) throw new Error("Falta ID de Localidad.");

                    const payload = {
                        action: "registerDynamicDataTD",
                        TABLA_DESTINO: tableName,
                        CAMPO_CLAVE: getTablePrimaryKey(Object.keys(formPayload), tableName),
                        // Dinamismo total: El campo de localidad ahora sigue el prefijo de la tabla
                        [`${tablePrefix}LOC`]: tiendaId, 
                        [`${tablePrefix}RegistroUser`]: localStorage.getItem(KEYS.USUARIO_ID) || "UserSys",
                        ...formPayload
                    };

                    await executeSubmit(payload, 'Nuevo Registro');
                } catch (err) {
                    showSystemModal({ title: 'Error', text: err.message, type: 'warning' });
                }
        }   

        function renderToggleHTML(label, value, status, isBlocked, prefix, colId) {
            const displayStatus = (status === "" || status === "Registrado") ? "Registrado" : status;           
            return `
                <div class="border-b border-gray-700/40 py-1">
                    <span class="text-[10px] font-bold text-blue-400 uppercase block -mb-1">${label}</span>
                    <div class="flex items-center justify-between min-h-[32px] gap-2">
                        <div class="flex items-center gap-2 flex-1">
                            <input type="text" name="${colId}" value="${value}" class="bg-transparent outline-none border-none focus:ring-0 text-[22px] text-blue-300 font-bold leading-tight p-0 m-0 w-full">
                            <span id="badge-status" class="text-[10px] px-2 py-0.5 rounded-full uppercase font-bold transition-all ${isBlocked ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-green-500/20 text-green-400 border border-green-500/30'}">
                                ${displayStatus}
                            </span>
                        </div>
                        <input type="hidden" name="${prefix}TYPEREG" id="input-typereg" value="${status}">
                        <button type="button" onclick="toggleRecordStatus('${prefix}')" class="focus:outline-none flex items-center">
                            <i id="toggle-icon" data-lucide="${isBlocked ? 'toggle-left' : 'toggle-right'}" class="w-8 h-8 ${isBlocked ? 'text-red-500' : 'text-green-500'}"></i>
                        </button>
                    </div>
                </div>`;
        }
             
        function showViewMode() {
            const data = JSON.parse(localStorage.getItem('TABLE_DATA') || '{}');
            if (data.IS_NEW === true) {
                window.location.href = 'Datos2.html';
                return;
            }
            const detailPanel = document.getElementById('DetalleDataContent');
            const editPanel = document.getElementById('EditDataContent');           
            if (detailPanel && editPanel) {
                detailPanel.classList.remove('hidden');
                editPanel.classList.add('hidden');
            }
        }

        function showRegisterMode() {
            const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG));
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA));  
            const friendlyName = getFriendlyTableName(data.TABLA_ORIGEN);

            // T铆tulo din谩mico para Nuevo Registro
            document.getElementById('formTitle').textContent = `Nuevo Registro: ${friendlyName}`;
            
            document.getElementById('formAction').value = "registerDynamicDataTD";
            document.getElementById('submitBtn').textContent = "Crear Nuevo Registro";
            
            renderFields(config, { TABLA_ORIGEN: data.TABLA_ORIGEN }, true);
            togglePanels('edit');
        }

        function showEditMode() {
            const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG));
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA));
            const friendlyName = getFriendlyTableName(data.TABLA_ORIGEN);

            // T铆tulo din谩mico para Edici贸n
            document.getElementById('formTitle').textContent = `Editar Selecci贸n: ${friendlyName}`;
            
            document.getElementById('formAction').value = "editDynamicDataTD";
            document.getElementById('submitBtn').textContent = "Guardar Cambios";           
            
            renderFields(config, data, false);
            togglePanels('edit');
        }

        async function showExcludedMode() {
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA));
            const tableName = data.TABLA_ORIGEN;
            const tablePrefix = tableName.split('_')[0].toUpperCase(); // Obtener prefijo (ej. TD102)
            const pkField = getTablePrimaryKey(Object.keys(data), tableName);          
            
            const confirm = await showSystemModal({
                title: '驴Confirmar Bloqueo?',
                text: `El registro ser谩 marcado como "Bloqueado".`,
                type: 'warning',
                confirmText: 'S铆, Bloquear'
            });

            if (confirm) {
                const payload = {
                    action: 'editDynamicDataTD',
                    TABLA_DESTINO: tableName,
                    CAMPO_CLAVE: pkField,
                    [`${tablePrefix}RegistroUser`]: localStorage.getItem(KEYS.USUARIO_ID),
                    [pkField]: data[pkField],
                    [`${tablePrefix}TYPEREG`]: 'Bloqueado' // Prefijo din谩mico
                };
                await executeSubmit(payload);
            }
        }

        async function showRestoreMode() {
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA));
            const tableName = data.TABLA_ORIGEN;
            const pkField = getTablePrimaryKey(Object.keys(data), tableName);           
            const confirm = await showSystemModal({
                title: '驴Restaurar Registro?',
                text: `El registro volver谩 al estado "Registrado" y ser谩 visible en todas las consultas.`,
                type: 'confirm' // Usando la l贸gica de confirmaci贸n con dos botones
            });
            if (confirm) {
                const payload = {
                    action: 'editDynamicDataTD',
                    TABLA_DESTINO: tableName,
                    CAMPO_CLAVE: pkField,
                    TD101RegistroUser: localStorage.getItem(KEYS.USUARIO_ID),
                    [pkField]: data[pkField],
                    TD101TYPEREG: 'Registrado' // Revertimos el estado
                };
                await executeSubmit(payload);
            }
        }

        function togglePanels(mode) {
            const detailPanel = document.getElementById('DetalleDataContent');
            const editPanel = document.getElementById('EditDataContent');            
            if (mode === 'edit') {
                detailPanel.classList.add('hidden');
                editPanel.classList.remove('hidden');
            } else {
                editPanel.classList.add('hidden');
                detailPanel.classList.remove('hidden');
            }
        }

        // Funci贸n centralizada para comunicaci贸n con GAS
        async function executeSubmit(payload, customTitle = '隆xito!') {
            try {
                const r = await fetch(GAS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: new URLSearchParams(payload) 
                });
                const res = await r.json();

                if (res.success) {
                    // Si el backend devuelve nuevos datos (como el ID generado), los guardamos
                    if (res.data) {
                        const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
                        localStorage.setItem(STORAGE_DATA, JSON.stringify({
                            ...currentData,
                            ...res.data,
                            IS_NEW: false
                        }));
                    }

                    // Usamos res.message directamente del backend
                    await showSystemModal({
                        title: customTitle, 
                        text: res.message, 
                        type: 'info' // Compatible con tu plantilla
                    });
                    
                    location.reload();
                } else {
                    await showSystemModal({
                        title: 'Error', 
                        text: res.message, 
                        type: 'warning'
                    });
                }
            } catch (err) {
                console.error("Error de red:", err);
                await showSystemModal({
                    title: 'Error', 
                    text: 'Error de conexi贸n con el servidor', 
                    type: 'warning'
                });
            }
        }
    </script>
        <script>
        function setupNombreCAutoCalculate(tablePrefix) {
            const n1 = document.getElementById(`input-${tablePrefix}NOMBRE1`);
            const n2 = document.getElementById(`input-${tablePrefix}NOMBRE2`);
            const nc = document.getElementById(`input-${tablePrefix}NOMBREC`);
            if (!n1 || !n2 || !nc) return;
            const particles = ["de los", "de la", "de", "del", "mc"];
            const processNombre1 = (text) => {
                const val = text.trim();
                if (!val) return "";
                const parts = val.split(/\s+/);               
                for (let i = 0; i < parts.length; i++) {
                    for (let p of particles) {
                        const pParts = p.split(" ");
                        if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                            const blockBefore = parts.slice(0, i + pParts.length).join(" ");
                            if (parts[i + pParts.length]) {
                                const initial = parts[i + pParts.length].charAt(0).toUpperCase();
                                return `${blockBefore} ${initial}.`; // Ej: MARIA DE LOS C.
                            }
                            return blockBefore;
                        }
                    }
                }
                let res = parts[0];
                if (parts[1]) res += " " + parts[1].charAt(0).toUpperCase() + ".";
                return res;
            };
            const processNombre2 = (text) => {
                const val = text.trim();
                if (!val) return "";
                if (val.toLowerCase().startsWith("o'")) {
                    const parts = val.split(/\s+/);
                    return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
                }
                const parts = val.split(/\s+/);
                for (let p of particles) {
                    const pParts = p.split(" ");
                    if (parts.slice(0, pParts.length).join(" ").toLowerCase() === p) {
                        const mainBlock = parts.slice(0, pParts.length + 1).join(" ");
                        const remaining = parts.slice(pParts.length + 1);
                        return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                    }
                    for (let i = 1; i < parts.length; i++) {
                        if (parts.slice(i, i + pParts.length).join(" ").toLowerCase() === p) {
                            const mainBlock = parts.slice(0, i + pParts.length + 1).join(" ");
                            const remaining = parts.slice(i + pParts.length + 1);
                            return remaining.length > 0 ? `${mainBlock} ${remaining[0].charAt(0).toUpperCase()}.` : mainBlock;
                        }
                    }
                }
                return parts[1] ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
            };
            const calculate = () => {
                const n1Val = processNombre1(n1.value);
                const n2Val = processNombre2(n2.value);               
                let final = n1Val;
                if (n2Val) final += (final ? " " : "") + n2Val;
                nc.value = final.toUpperCase();
            };
            n1.addEventListener('input', calculate);
            n2.addEventListener('input', calculate);
        }

console.group(" REVISIN DE LOCALSTORAGE");
console.log(" Datos de Usuario (KEYS):");
Object.entries(KEYS).forEach(([key, storageKey]) => {
    console.log(`   ${key}: ${localStorage.getItem(storageKey)}`);
});

console.log(" Configuraci贸n de Tabla (TABLE_CONFIG):");
console.table(JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}'));

console.log(" Datos de la Fila (TABLE_DATA):");
console.table(JSON.parse(localStorage.getItem('TABLE_DATA') || '{}'));
console.groupEnd();

    </script>
</body>
</html>
