<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ZXC - Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family:'Inter',sans-serif; -webkit-tap-highlight-color:transparent; }
        :root { --bg: #1f2937;--txt: #f3f4f6;--surf: #374151;--p-soft: #60a5fa; } /* VARIABLES POR DEFECTO (DARK) */
        .light-mode { --bg: #f9fafb; --txt: #111827; --surf: #ffffff; } 
        .light-mode header, .light-mode footer { border-color: #e5e7eb; }
        html, body { background-color: var(--bg); color: var(--txt); transition: background .3s, color .3s; }   
        #app-container { width:100%; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; box-shadow:0 0 20px rgba(0,0,0,.2); position:relative; transition:max-width .4s ease-in-out; }
        #app-container { background-color: var(--bg); }
        .mode-mobile { max-width:500px; }
        .mode-desktop { max-width:100%!important; }
        header,footer { width:100%; max-width:inherit; z-index:50; left:50%; transform:translateX(-50%); position:fixed; background:var(--surf); border-color:#4b5563; }
        header { background: #374151 !important;color: #f3f4f6 !important;border-color: #4b5563 !important;}
        header h1 { color: white !important; }       
        main { flex-grow:1; overflow-y:auto; padding:76px 1rem 72px; }
        .footer-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:.75rem; color:var(--txt); cursor:pointer; transition:color .2s; }
        .footer-btn:hover { color:#152c94; }
        .footer-btn.active { color:var(--p-soft); font-weight:700; }
        .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.8); backdrop-filter:blur(4px); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--surf); border:1px solid #4b5563; border-radius:1rem; width:90%; max-width:320px; }
        .light-mode .modal-content { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display:none; }
        .btn-disabled { opacity: 0.3 !important;cursor: not-allowed !important;pointer-events: none !important;filter: grayscale(1); }
    </style>
    <style>
        /* ESTILOS ESPEC√çFICOS DE LA SECCI√ìN (SPA FormData) */
        .input-form{margin-top:0.25rem;display:block;width:100%;padding:0.5rem 1rem;background-color:#1f2937;border:1px solid #4b5563;border-radius:0.5rem;color:white;outline:none}
        .input-form:focus{border-color:#3b82f6}
    </style>
</head>
<body class="dark">
    <div id="app-container" class="mode-mobile shadow-xl">
        <header class="top-0 h-14 border-b flex items-center justify-between px-6">
            <h1 class="text-xl font-bold text-white truncate mr-2">Cargando...</h1>
            <div class="flex items-center gap-3">
                <button id="btn-toggle-view" class="p-2" onclick="toggleView()"><div id="view-icon-container"></div></button>
                <button class="p-2 text-red-400" onclick="logout()"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </div>
        </header>

        <main id="main-content">
            <div id="DetalleDataContent" class="p-6 bg-gray-800 rounded-xl border border-gray-700">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-1">
                    <h3 class="text-3xl font-bold text-blue-400">Detalle Selecci√≥n</h3>
                    <button onclick="showEditMode()" class="text-yellow-400 hover:text-yellow-600"><i data-lucide="pencil" class="w-6 h-6"></i></button>
                </div>
                <div id="perfilBodyContent" class="space-y-1 pb-20"></div>
            </div>

            <div id="EditDataContent" class="p-6 bg-gray-800 rounded-xl border border-gray-700 hidden">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-1">
                    <h2 class="text-3xl font-bold text-white">Editar Selecci√≥n</h2>
                    <button onclick="showViewMode()" class="text-red-400 hover:text-red-600"><i data-lucide="circle-x" class="w-7 h-7"></i></button>
                </div>
                <form id="editDataForm" class="space-y-1">
                    <input type="hidden" id="Usuario_Correo_Actual" name="Usuario_Correo_Actual">               
                    <div id="editDataFormFields" class="space-y-1"></div>
                    <button type="submit" class="w-full bg-blue-600 mt-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-all active:scale-95">Guardar Cambios</button>
                </form>
                <p class="text-sm text-gray-400 text-center pt-4 pb-12">Los campos que no sean modificados mantendr√°n su valor.</p>
            </div>
        </main>
        <footer id="app-footer" class="bottom-0 h-18 border-t flex items-center justify-around px-2 py-1">
            <button class="footer-btn" data-section="Base"><i data-lucide="house-plus" class="w-6 h-6"></i><span>Base</span></button>
            <button id="btn-datos" class="footer-btn active" data-section="Datos"><i data-lucide="database" class="w-6 h-6"></i><span>Datos</span></button>
            <button id="btn-agregar" class="footer-btn" data-section="Agregar"><i data-lucide="plus-circle" class="w-6 h-6"></i><span>Agregar</span></button>
            <button class="footer-btn" data-section="Perfil"><i data-lucide="user" class="w-6 h-6"></i><span>Perfil</span></button>
            <button class="footer-btn" data-section="Configuracion"><i data-lucide="settings" class="w-6 h-6"></i><span>Config</span></button>
        </footer>
    </div>

    <div id="system-modal" class="hidden modal-overlay">
        <div class="modal-content p-6 text-center">
            <div id="sys-modal-icon" class="mb-4 flex justify-center"></div>
            <h3 id="sys-modal-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="sys-modal-text" class="text-gray-400 text-sm mb-6"></p>
            <div id="sys-modal-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <script>
        const KEYS={NOMBRE:'Usuario_Nombre',PERFIL:'Usuario_Perfil',CORREO:'Usuario_Correo',VIEW_MODE:'App_View_Mode',THEME:'App_Theme',TIENDA:'Usuario_Tienda',TIENDA_ID:'Usuario_Tienda_ID',USUARIO_ID:'Usuario_ID',USUARIO_ID:'INPUT_ID'};
        document.addEventListener('DOMContentLoaded',()=>{if(!localStorage.getItem(KEYS.CORREO))window.location.replace('index.html');initUI();if(window.lucide)lucide.createIcons()});
        function initUI(){
            const nom = localStorage.getItem(KEYS.NOMBRE);
            if(nom) document.querySelector('h1').textContent = `¬°Hola, ${nom.trim().split(/\s+/)[0]}!`;
            applyViewMode(localStorage.getItem(KEYS.VIEW_MODE) || 'mobile');
            document.querySelectorAll('.footer-btn').forEach(b => b.onclick = () => loadContent(b.getAttribute('data-section')));
            if(!localStorage.getItem(KEYS.INPUT_ID)){['btn-agregar'].forEach(id => {const el = document.getElementById(id);if(el) el.classList.add('btn-disabled'); });}
        }
        function toggleView(){const m=localStorage.getItem(KEYS.VIEW_MODE)==='desktop'?'mobile':'desktop';localStorage.setItem(KEYS.VIEW_MODE,m);applyViewMode(m)}
        function applyViewMode(m){
            const c=document.getElementById('app-container'),i=document.getElementById('view-icon-container');
            if(m==='desktop'){c.classList.replace('mode-mobile','mode-desktop');i.innerHTML='<i data-lucide="smartphone" class="w-5 h-5 text-blue-400"></i>'}
            else{c.classList.replace('mode-desktop','mode-mobile');i.innerHTML='<i data-lucide="monitor" class="w-5 h-5 text-emerald-400"></i>'}
            if(window.lucide)lucide.createIcons();
        }
        async function loadContent(s){
            const NAV={'Base':'Base2.html','Inicio':'Inicio.html','Datos': 'Datos2.html','Agregar':'AgregarDat.html','Perfil':'PerfilUser2.html','Configuracion':'ConfigApp.html'};
            if(['Agregar'].includes(s) && !localStorage.getItem(KEYS.INPUT_ID)){return showSystemModal({title:'Acceso Imposible', text:'Registre el dato CLAVE para su b√∫squeda en la secci√≥n correspondiente.', type:'warning'});}    
            if(s==='Configuracion' && localStorage.getItem(KEYS.PERFIL)!=='Admin') return showSystemModal({title:'Acceso Denegado',text:'Solo administradores.',type:'warning'});
            if(NAV[s]) window.location.href=NAV[s];
        }     
        function showSystemModal({title,text,type='info'}){
            return new Promise(res=>{
                const m=document.getElementById('system-modal'),ti=document.getElementById('sys-modal-title'),te=document.getElementById('sys-modal-text'),ic=document.getElementById('sys-modal-icon'),ac=document.getElementById('sys-modal-actions');
                ti.textContent=title;te.textContent=text;const colors={warning:'text-amber-400',info:'text-blue-400'},icons={warning:'alert-triangle',info:'info'};
                ic.innerHTML=`<i data-lucide="${icons[type]}" class="w-12 h-12 ${colors[type]}"></i>`;ac.innerHTML='';
                const b=document.createElement('button');b.className='px-6 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold';b.textContent='Aceptar';
                b.onclick=()=>{m.classList.add('hidden');res(true)};ac.appendChild(b);m.classList.remove('hidden');lucide.createIcons();
            });
        }
        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light-mode');
            localStorage.setItem(KEYS.THEME, isLight ? 'light' : 'dark');
            renderTiendaFooter();
            if(window.lucide) lucide.createIcons();
        }
        function applyTheme() {
            const theme = localStorage.getItem(KEYS.THEME) || 'dark';
            if (theme === 'light') {document.documentElement.classList.add('light-mode');} 
            else {document.documentElement.classList.remove('light-mode');}
        }
        function toggleGlobalLoader(show) {
            const loader = document.getElementById('global-loader');
            if (loader) { loader.classList.toggle('hidden', !show);
            if (show && window.lucide) lucide.createIcons(); }
        }
        function formatNumberWithDots(v) {
            if (!v && v !== 0) return '';
            const number = parseFloat(String(v).replace(',', '.'));
            if (isNaN(number)) return v;
            const decimals = Math.abs(number - Math.round(number)) < 0.001 ? 0 : 2;
            return new Intl.NumberFormat('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(number);
        }
        function formatDate(v) {
            if (!v) return 'N/A';
            const d = new Date(v);
            return isNaN(d.getTime()) ? v : `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
        }
        function formatDateTime(v) {
            if (!v) return 'N/A';
            const d = new Date(v);
            if (isNaN(d.getTime())) return v;
            return `${formatDate(v)} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
        }
        function logout(){localStorage.clear();window.location.href='index.html'}
    </script>

    <script>
        console.log("Valores de Perfil:");
        Object.entries(KEYS).forEach(([key, storageKey]) => {
            console.log(`${key}: ${localStorage.getItem(storageKey)}`);
        });        
        
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz29nU5Ra_k_RZ9BpXUp5D6YAQx3cScf_WDVHjPcJo-gOYtUQ-leW7GU6qSOM85Mbq_/exec";
        
        // Nombres de las llaves en localStorage
        const STORAGE_CONFIG = 'TABLE_CONFIG'; // Nombre agn√≥stico
        const STORAGE_DATA = 'TABLE_DATA';     // Nombre agn√≥stico

        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem(KEYS.CORREO)) {
                renderProfile();
                const form = document.getElementById('editDataForm');
                if(form) form.onsubmit = handleEditSubmit;
            } else {
                window.location.replace('index.html');
            }
        });

        /**
         * Renderiza la vista de lectura (Detalle)
         * Vincula etiquetas de CONFIG con valores de DATA
         */
        function renderProfile() {
            const config = JSON.parse(localStorage.getItem(STORAGE_CONFIG) || '{}');
            const data = JSON.parse(localStorage.getItem(STORAGE_DATA) || '{}');
            const container = document.getElementById('perfilBodyContent');

            if (Object.keys(config).length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic text-center py-10">No hay datos seleccionados.</p>`;
                return;
            }

            // Generamos el HTML recorriendo el mapa de configuraci√≥n para mantener el orden de la tabla
            container.innerHTML = Object.keys(config).map(colId => {
                const label = config[colId].label;
                const value = data[colId] || '---';
                
                // Estilo resaltado para campos principales (IDs o Nombres)
                const isImportant = colId.includes('ID') || colId.includes('NOMBREC');
                const valueClass = isImportant ? 'text-[22px] text-blue-300 font-bold leading-tight' : 'text-[18px] text-gray-200 leading-tight';

                return `
                    <div class="border-b border-gray-700/40 py-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase block -mb-1">${label}</span>
                        <div class="flex items-center min-h-[32px]">
                            <span class="${valueClass}">${value}</span>
                        </div>
                    </div>
                `;
            }).join('');

            if(window.lucide) lucide.createIcons();
        }

        function showEditMode() {
            console.log("üü° Iniciando showEditMode...");
            
            const configRaw = localStorage.getItem('TABLE_CONFIG');
            const dataRaw = localStorage.getItem('TABLE_DATA');
            
            if (!configRaw || !dataRaw) {
                console.error("‚ùå No se encontraron datos en localStorage");
                return;
            }

            const config = JSON.parse(configRaw);
            const data = JSON.parse(dataRaw);

            console.log("üìä MAPA DE CONFIGURACI√ìN RECIBIDO:");
            console.table(config);

            const container = document.getElementById('editDataFormFields');
            const detailContent = document.getElementById('DetalleDataContent');
            const editContent = document.getElementById('EditDataContent');

            if (detailContent) detailContent.classList.add('hidden');
            if (editContent) editContent.classList.remove('hidden');

            container.innerHTML = Object.keys(config).map(colId => {
                const field = config[colId]; 
                const value = data[colId] || '';
                const cleanColId = colId.toUpperCase();

                // --- L√≥gica de Estilo Unificada ---
                const isImportant = cleanColId.includes('ID') || cleanColId.includes('NOMBREC') || cleanColId.includes('DAT01');
                const valueClass = isImportant 
                    ? 'text-[22px] text-blue-300 font-bold leading-tight' 
                    : 'text-[18px] text-gray-200 leading-tight';

                if (field.editable === false) {
                    // Render como texto est√°tico (Bloqueado)
                    return `
                        <div class="border-b border-gray-700/40 py-1 opacity-70">
                            <span class="text-[10px] font-bold text-gray-500 uppercase block -mb-1">${field.label}</span>
                            <div class="flex items-center h-[32px]">
                                <span class="${valueClass}">${value || '---'}</span>
                            </div>
                            <input type="hidden" name="${colId}" value="${value}">
                        </div>`;
                } else {
                    // Render como Input (Editable)
                    return `
                        <div class="border-b border-blue-700/40 py-1 group hover:bg-gray-700/20 transition-colors">
                            <label class="text-[10px] font-bold text-blue-400 uppercase block -mb-1">${field.label}</label>
                            <div class="flex items-center h-[32px]">
                                <input type="text" name="${colId}" value="${value}" 
                                    class="w-full bg-transparent outline-none border-none focus:ring-0 ${valueClass} p-0 m-0">
                            </div>
                        </div>`;
                }
            }).join('');

            if(window.lucide) lucide.createIcons();
            console.log("‚úÖ Formulario de edici√≥n renderizado con fuentes sincronizadas.");
        }

        function showViewMode() { 
            document.getElementById('EditDataContent').classList.add('hidden'); 
            document.getElementById('DetalleDataContent').classList.remove('hidden'); 
        }

        /**
         * Env√≠o de datos a Google Apps Script
         */
        async function handleEditSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const submitBtn = f.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            
            submitBtn.textContent = "Procesando...";
            submitBtn.disabled = true;

            const formData = new FormData(f);
            const currentData = JSON.parse(localStorage.getItem(STORAGE_DATA));
            
            // Combinamos los datos del formulario con la metadata (TABLA_ORIGEN)
            const payload = {
                action: 'editDynamicProfile',
                Usuario_Tienda: localStorage.getItem(KEYS.TIENDA),
                TABLA_DESTINO: currentData.TABLA_ORIGEN,
                ...Object.fromEntries(formData.entries())
            };

            try {
                const r = await fetch(GAS_SCRIPT_URL, { method: 'POST', body: new URLSearchParams(payload) });
                const res = await r.json();

                if (res.success) {
                    // Actualizamos el objeto DATA en local preservando la TABLA_ORIGEN
                    const newData = { ...currentData, ...Object.fromEntries(formData.entries()) };
                    localStorage.setItem(STORAGE_DATA, JSON.stringify(newData));
                    
                    await showSystemModal({title:'¬°√âxito!', text:'Datos actualizados correctamente.', type:'info'});
                    location.reload();
                } else {
                    await showSystemModal({title:'Error', text: res.message || "Error al actualizar", type:'warning'});
                }
            } catch (err) { 
                await showSystemModal({title:'Error', text:'Error de conexi√≥n con el servidor', type:'warning'}); 
            } finally { 
                submitBtn.textContent = originalBtnText; 
                submitBtn.disabled = false; 
            }
        }
    </script>
</body>
</html>